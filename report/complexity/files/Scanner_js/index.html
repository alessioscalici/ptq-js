<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - Scanner.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>Scanner.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">115.63</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">341</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">77.73</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.04</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * 
 * Contains the scanning algorythm and represents a single
 * scanner DFA. It also handles symbol actions like DFA start, end and switch, newlines
 * and ignoring symbols.
 *
 * @param {string} name the Scanner name (the PTQ project name)
 *
 *
 *
 * @property {string} name the scanner name (project name)
 * @property {object} scanners maps SubScanner name -&gt; SubScanner
 * @property {TerminalSymbol[]} arSymbolTable ordered array of symbols
 * @property {SubScanner} currentScanner the current SubScanner
 * @property {SubScanner} initialScanner the initial SubScanner
 * @property {SubScanner} initialScanner the initial SubScanner
 * @property {PushbackReader} source the source reader
 * @property {number} firstIgnoredIndex the index of the first symbol ignored by all of the SubScanners
 * @property {boolean} indenting (only for indentation driven scanners) true if the scanner is currently reading indenting tokens
 * @property {SubScanner[]} scannerStack the nested SubScanner stack
 * @property {Position} curPos the current Position
 * @property {Position} begPos the current token beginning Position
 * @property {number} level (only for indentation driven scanners) the current block indentation level
 * @property {number[]} levelStack (only for indentation driven scanners) a stack of nested blocks indentation levels
 * @property {TerminalNode[]} queue (only for indentation driven scanners) a queue of terminal nodes to be returned by the .scan() method
 * 
 * @constructor
 * @author Alessio Scalici
 */
var Scanner = function(name)  {

    this.name = name;
    this.scanners = {}; // FIXME USED?
    this.arSymbolTable = [];
    this.currentScanner = null;
    this.initialScanner = null;
    this.source = null;
    this.firstIgnoredIndex = -1;

    this.reset();
};


/** The first Position initial line, defaults to 1 */
Scanner.INITIAL_LINE = 1;

/** The first Position initial column, defaults to 1 */
Scanner.INITIAL_COL = 1;

/** The first Position initial index, defaults to 0 */
Scanner.INITIAL_POS = 0;



/**
 * Resets the parser to parse a new input string
 */
Scanner.prototype.reset = function() {

    this.curPos = new Position(Scanner.INITIAL_LINE, Scanner.INITIAL_COL, Scanner.INITIAL_POS);
    this.begPos = new Position(Scanner.INITIAL_LINE, Scanner.INITIAL_COL, Scanner.INITIAL_POS);

    this.scannerStack = [];
    this.source = null;
    this.currentScanner = this.initialScanner;

    if (this.indentBased) {
        this.indenting = true;
        this.level = 0;
        this.levelStack = [];
        this.queue = [];
    }
};


/**
 * Process indentation level before returning the recognized token
 * 
 */
Scanner.prototype.processLevel = function() {

    var me = this;
    var lastLevel = function(){
        return me.levelStack[me.levelStack.length-1];
    };


    if (this.levelStack.length === 0) {

        this.levelStack.push(this.level);

    } else {

        if (lastLevel() &lt; this.level) {

            this.levelStack.push(this.level);
            this.queue.unshift(this.createBeginBlock());

        } else if (lastLevel() &gt; this.level) {

            var prev = this.levelStack.pop();
            this.queue.unshift(this.createEndBlock());

            while (this.levelStack.length &amp;&amp; lastLevel() &gt; this.level) {
                prev = this.levelStack.pop();
                this.queue.unshift(this.createEndBlock());
                if (this.queue.length === 0) {
                    break;
                }
            }

            if ((this.queue.length !== 0 &amp;&amp; lastLevel() !== this.level) || (this.levelStack.length === 0 &amp;&amp; prev !== this.level)) {
                this.queue.unshift(this.createErrorBlock());
            }
        }
    }
};


/**
 * Close the pending opened blocks (at the end of input)
 */
Scanner.prototype.closePendingBlocks = function() {
    while (this.levelStack.length &gt; 1) {
        this.levelStack.pop();
        this.queue.unshift(this.createEndBlock());
    }
};


/**
 * Create a special begin-block Terminal node (_BEGIN_)
 * 
 * @return {TerminalNode} a special begin-block Terminal node (_BEGIN_)
 */
Scanner.prototype.createBeginBlock = function() {
    return new TerminalNode(this.arSymbolTable[SpecialSymbol.BEGIN.code]);

};


/**
 * Create a special end-block Terminal node (_END_)
 * 
 * @return {TerminalNode} a special end-block Terminal node (_END_)
 */
Scanner.prototype.createEndBlock = function() {
    return new TerminalNode(this.arSymbolTable[SpecialSymbol.END.code]);
};


/**
 * Create a special indentation error Terminal node (_ERROR_)
 * 
 * @return {TerminalNode} a special indentation error Terminal node (_ERROR_)
 */
Scanner.prototype.createErrorBlock = function() {
    return new TerminalNode(this.arSymbolTable[SpecialSymbol.ERROR.code]);

};


/**
 * Recognizes the next token and returns the resulting TerminalNode.
 * If a lexical error occurs, returns an error token (TerminalNode whose .isError() method returns true).
 * If the stream is finished, return an end-of-stream token (TerminalNode whose .isEOS() method returns true).
 * 
 * @return {TerminalNode} the recognized token, or an error / EOS token
 */
Scanner.prototype.scan = function() {

    var res = null;

    do {

        if (this.indentBased) {

            if (this.queue.length === 0) {
                res = this.currentScanner.scan();
            }

            // during the scan, the queue could change!
            if (this.queue.length !== 0) {

                // TerminalNode
                var firstInQueue = this.queue.splice(0,1)[0];

                // Action
                var act = this.currentScanner.getAction(firstInQueue.symbol);

                if (act &amp;&amp; (act.end || act.start || act.gotoTarget)) {
                    if (act.end) {
                        this.end();
                    }
                    if (act.start) {
                        this.begin(act.start);
                    }
                    if (act.gotoTarget) {
                        this.currentScanner = act.gotoTarget;
                    }

                    if (res) {// nulls last token

                        var data = res.data;
                        for (var i=0; i&lt;data.length; ++i) {
                            this.source.unread(data.charCodeAt(i));
                        }
                        this.tokenReset();
                    }
                }
                else if (res) {// put token in queue

                    this.queue.push(res);
                }

                res = firstInQueue;
            }


        } else { // not indent based

            res = this.currentScanner.scan();

        }

    }
    while (!res);

    res.pos = this.begPos.clone();


    return res;
};


/**
 * Initializes the current Scanner
 *
 * @param {SubScanner[]} sSet the SubScanner set for this Scanner
 * @param {number} initial the initial SubScanner index
 * @param {TerminalSymbol[]} symbols the Scanner symbol table

 */
Scanner.prototype.init = function(sSet, initial, symbols) {

    this.arSymbolTable = symbols;

    // FIXME USED??? is it useful in the JS lib???
    this.firstIgnoredIndex = this.arSymbolTable.length;


    this.scanners = {};

    for (var i=0; i&lt;sSet.length; ++i) {
        this.scanners[sSet[i].name] = sSet[i];
        sSet[i].parent = this;
    }
    this.initialScanner = this.scanners[initial];
    this.currentScanner = this.initialScanner;
};


/**
 * Returns the symbol given the name
 * 
 * @param {string} sName the symbol&#039;s name
 * @return {TerminalSymbol} the symbol given the name
 */
//FIXME find better method (no string)... USED???
Scanner.prototype.getSymbol = function(sName) {

    if (typeof sName === &#039;number&#039;) {
        return this.arSymbolTable[sName];
    }

    for (var i=0; i&lt;this.arSymbolTable.length; ++i) {
        if (this.arSymbolTable[i].name === sName) {
            return this.arSymbolTable[i];
        }
    }

    throw &quot;&#039;&quot; + sName + &quot;&#039; is not a symbol name&quot;;
};



/**
 * Starts a new nested SubScanner
 * 
 * @param {BaseSubScanner} ss the new nested SubScanner
 */
Scanner.prototype.begin = function(ss) {
    if (ss) {
        this.scannerStack.push(this.currentScanner);
        this.currentScanner = ss;
    }
};


/**
 * Terminates the current nested SubScanner and returns to the previous one.
 * If no SubScanner is in the stack (it wasn&#039;t started), returns
 */
Scanner.prototype.end = function() {
    if (!this.scannerStack.length) {
        return;
    }
    this.currentScanner = this.scannerStack.pop();
};


/**
 * Marks the token begin position
 */
Scanner.prototype.tokenBegin = function() {
    this.begPos = this.curPos.clone();
};


/**
 * Resets the current token position
 */
Scanner.prototype.tokenReset = function() {
    this.curPos = this.begPos.clone();
};


/**
 * Increase the current position
 * 
 * @param {number} amt the amount to increase the column number
 */
Scanner.prototype.newCol = function(amt) {
    this.curPos.col += amt;
    this.curPos.index += amt;
};


/**
 * Sets the input source string
 * 
 * @param {string} s the string containing the text to scan
 */
Scanner.prototype.setSource = function(s) {
    this.reset();
    this.source = new PushbackReader(s);
};


/**
 * Returns a partial symbol table, with just the
 * terminal symbols that are not ignored
 * 
 * @return {TerminalSymbol[]} a partial symbol table, with just the
 * terminal symbols that are not ignored
 */
// FIXME USED?
Scanner.prototype.getPublicSymbolTable = function() {
    return this.arSymbolTable.slice(0, this.firstIgnoredIndex);
};

/**
 * Returns the entire symbol table
 * 
 * @return {TerminalSymbol[]} the entire symbol table
 */
// FIXME USED?
Scanner.prototype.getInternalSymbolTable = function() {
    return this.arSymbolTable;
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
